{
  "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "tenantName": {
      "type": "string",
      "defaultValue": "tenant",
      "metadata": {
        "description": "Tenant name, to be used as seed prefix for some resources"
      }
    },
    "adminUsername": {
      "type": "string",
      "defaultValue": "azureuser",
      "metadata": {
        "description": "Admin username on all VMs."
      }
    },
    "adminPublicKey": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "ssh public key for connecting to VMs."
      }
    },
    "jumpBoxSize": {
      "type": "string",
      "defaultValue": "Standard_B1ms",
      "allowedValues": [
        "Standard_A0",
        "Standard_A1_v2",
        "Standard_B1s",
        "Standard_B1ms",
        "Standard_F1"
      ],
      "metadata": {
        "description": "VM size for the SSH jumpbox"
      }
    },
    "jumpBoxCustomData": {
      "type": "string",
      "metadata": {
        "description": "CustomData for initializing jumpbox"
      }
    },
    "diagStorageType": {
      "type": "string",
      "defaultValue": "Standard_LRS",
      "allowedValues": [
        "Standard_LRS",
        "Premium_LRS"
      ],
      "metadata": {
        "description": "Default storage account type for resources"
      }
    },
    "servicesTag": {
      "type": "string",
      "defaultValue": "ssh",
      "metadata": {
        "description": "Comma-separated list of services for visual tracking"
      }
    },
    "serverSubnet": {
      "type": "string",
      "defaultValue": "devops",
      "metadata": {
        "description": "Default subnet where to place machines"
      }
    }
  },
  "variables": {
    "tenantName": "[toLower(parameters('tenantName'))]",
    "diagsName": "[substring(concat(variables('tenantName'), 'diag', toLower(uniqueString(resourceGroup().id))), 0, 20)]",
    "vnetName": "[variables('tenantName')]",
    "jumpBoxName": "[concat(variables('tenantName'),'Jumpbox')]",
    "omsWorkspaceName": "[concat(variables('tenantName'),'Monitoring')]",
    "bastionOSType": "Linux",
    "omsConfig": {
      "solutions": [
        {
          "name": "[concat('Security', '(', variables('omsWorkspaceName'), ')')]",
          "marketplaceName": "Security"
        },
        {
          "name": "[concat('AgentHealthAssessment', '(', variables('omsWorkspaceName'), ')')]",
          "marketplaceName": "AgentHealthAssessment"
        },
        {
          "name": "[concat('ChangeTracking', '(', variables('omsWorkspaceName'), ')')]",
          "marketplaceName": "ChangeTracking"
        },
        {
          "name": "[concat('Updates', '(', variables('omsWorkspaceName'), ')')]",
          "marketplaceName": "Updates"
        },
        {
          "name": "[concat('AzureActivity', '(', variables('omsWorkspaceName'), ')')]",
          "marketplaceName": "AzureActivity"
        },
        {
          "name": "[concat('Containers', '(', variables('omsWorkspaceName'), ')')]",
          "marketplaceName": "Containers"
        },
        {
          "name": "[concat('ServiceMap', '(', variables('omsWorkspaceName'), ')')]",
          "marketplaceName": "ServiceMap"
        }
      ]
    }
  },
  "resources": [
    {
      "comments": "Diagnostics storage account",
      "type": "Microsoft.Storage/storageAccounts",
      "name": "[variables('diagsName')]",
      "apiVersion": "2015-06-15",
      "location": "[resourceGroup().location]",
      "tags": {
        "tenant": "[variables('tenantName')]",
        "layer": "foundation",
        "purpose": "diagnostics"
      },
      "properties": {
        "accountType": "[parameters('diagStorageType')]"
      }
    },
    {
      "comments": "SSH jumpbox",
      "condition": "[equals(variables('bastionOSType'),'Linux')]",
      "type": "Microsoft.Compute/virtualMachines",
      "name": "[concat(variables('jumpBoxName'),'-linux')]",
      "apiVersion": "2017-03-30",
      "location": "[resourceGroup().location]",
      "tags": {
        "tenant": "[variables('tenantName')]",
        "layer": "foundation",
        "purpose": "jumpbox",
        "services": "[parameters('servicesTag')]",
        "os": "linux"
      },
      "properties": {
        "osProfile": {
          "computerName": "jumpbox",
          "adminUsername": "[parameters('adminUsername')]",
          "customData": "[parameters('jumpBoxCustomData')]",
          "linuxConfiguration": {
            "disablePasswordAuthentication": true,
            "ssh": {
              "publicKeys": [
                {
                  "path": "[concat('/home/', parameters('adminUsername'), '/.ssh/authorized_keys')]",
                  "keyData": "[parameters('adminPublicKey')]"
                }
              ]
            }
          }
        },
        "hardwareProfile": {
          "vmSize": "[parameters('jumpBoxSize')]"
        },
        "storageProfile": {
          "imageReference": {
            "publisher": "Canonical",
            "offer": "UbuntuServer",
            "sku": "16.04-LTS",
            "version": "latest"
          },
          "osDisk": {
            "name": "[variables('jumpBoxName')]",
            "caching": "ReadWrite",
            "createOption": "FromImage"
          },
          "dataDisks": []
        },
        "networkProfile": {
          "networkInterfaces": [
            {
              "id": "[resourceId('Microsoft.Network/networkInterfaces',variables('jumpBoxName'))]"
            }
          ]
        },
        "diagnosticsProfile": {
          "bootDiagnostics": {
            "enabled": true,
            "storageUri": "[concat('https', '://', variables('diagsName'), '.blob.core.windows.net')]"
          }
        }
      },
      "resources": [
        {
          "type": "Microsoft.Compute/virtualMachines/extensions",
          "name": "[concat(variables('jumpBoxName'), '-linux/Microsoft.Azure.Diagnostics')]",
          "apiVersion": "2017-03-30",
          "location": "[resourceGroup().location]",
          "dependsOn": [
            "[concat('Microsoft.Compute/virtualMachines/',variables('jumpBoxName'),'-linux')]",
            "[concat('Microsoft.Storage/storageAccounts/',variables('diagsName'))]"
          ],
          "properties": {
            "publisher": "Microsoft.Azure.Diagnostics",
            "type": "LinuxDiagnostic",
            "typeHandlerVersion": "3.0",
            "autoUpgradeMinorVersion": true,
            "protectedSettings": {
              "storageAccountName": "[variables('diagsName')]",
              "storageAccountKey": "[listKeys(resourceId('Microsoft.Storage/storageAccounts/',variables('diagsName')), '2015-06-15').key1]",
              "storageAccountEndPoint": "https://core.windows.net"
            },
            "settings": {
              "storageAccount": "[variables('diagsName')]",
              "ladCfg": {
                "diagnosticMonitorConfiguration": {
                  "eventVolume": "Medium",
                  "metrics": {
                    "metricAggregation": [
                      {
                        "scheduledTransferPeriod": "PT1M"
                      },
                      {
                        "scheduledTransferPeriod": "PT1H"
                      }
                    ],
                    "resourceId": "[resourceId('Microsoft.Compute/virtualMachines',variables('jumpBoxName'))]"
                  },
                  "syslogEvents": {
                    "syslogEventConfiguration": {
                      "LOG_AUTH": "LOG_DEBUG",
                      "LOG_AUTHPRIV": "LOG_DEBUG",
                      "LOG_CRON": "LOG_DEBUG",
                      "LOG_DAEMON": "LOG_DEBUG",
                      "LOG_FTP": "LOG_DEBUG",
                      "LOG_KERN": "LOG_DEBUG",
                      "LOG_LOCAL0": "LOG_DEBUG",
                      "LOG_LOCAL1": "LOG_DEBUG",
                      "LOG_LOCAL2": "LOG_DEBUG",
                      "LOG_LOCAL3": "LOG_DEBUG",
                      "LOG_LOCAL4": "LOG_DEBUG",
                      "LOG_LOCAL5": "LOG_DEBUG",
                      "LOG_LOCAL6": "LOG_DEBUG",
                      "LOG_LOCAL7": "LOG_DEBUG",
                      "LOG_LPR": "LOG_DEBUG",
                      "LOG_MAIL": "LOG_DEBUG",
                      "LOG_NEWS": "LOG_DEBUG",
                      "LOG_SYSLOG": "LOG_DEBUG",
                      "LOG_USER": "LOG_DEBUG",
                      "LOG_UUCP": "LOG_DEBUG"
                    }
                  },
                  "performanceCounters": {
                    "performanceCounterConfiguration": [
                      {
                        "annotation": [
                          {
                            "displayName": "CPU IO wait time",
                            "locale": "en-us"
                          }
                        ],
                        "class": "processor",
                        "condition": "IsAggregate=TRUE",
                        "counter": "percentiowaittime",
                        "counterSpecifier": "/builtin/processor/percentiowaittime",
                        "type": "builtin",
                        "unit": "Percent",
                        "sampleRate": "PT15S"
                      },
                      {
                        "annotation": [
                          {
                            "displayName": "CPU user time",
                            "locale": "en-us"
                          }
                        ],
                        "class": "processor",
                        "condition": "IsAggregate=TRUE",
                        "counter": "percentusertime",
                        "counterSpecifier": "/builtin/processor/percentusertime",
                        "type": "builtin",
                        "unit": "Percent",
                        "sampleRate": "PT15S"
                      },
                      {
                        "annotation": [
                          {
                            "displayName": "CPU nice time",
                            "locale": "en-us"
                          }
                        ],
                        "class": "processor",
                        "condition": "IsAggregate=TRUE",
                        "counter": "percentnicetime",
                        "counterSpecifier": "/builtin/processor/percentnicetime",
                        "type": "builtin",
                        "unit": "Percent",
                        "sampleRate": "PT15S"
                      },
                      {
                        "annotation": [
                          {
                            "displayName": "CPU percentage guest OS",
                            "locale": "en-us"
                          }
                        ],
                        "class": "processor",
                        "condition": "IsAggregate=TRUE",
                        "counter": "percentprocessortime",
                        "counterSpecifier": "/builtin/processor/percentprocessortime",
                        "type": "builtin",
                        "unit": "Percent",
                        "sampleRate": "PT15S"
                      },
                      {
                        "annotation": [
                          {
                            "displayName": "CPU interrupt time",
                            "locale": "en-us"
                          }
                        ],
                        "class": "processor",
                        "condition": "IsAggregate=TRUE",
                        "counter": "percentinterrupttime",
                        "counterSpecifier": "/builtin/processor/percentinterrupttime",
                        "type": "builtin",
                        "unit": "Percent",
                        "sampleRate": "PT15S"
                      },
                      {
                        "annotation": [
                          {
                            "displayName": "CPU idle time",
                            "locale": "en-us"
                          }
                        ],
                        "class": "processor",
                        "condition": "IsAggregate=TRUE",
                        "counter": "percentidletime",
                        "counterSpecifier": "/builtin/processor/percentidletime",
                        "type": "builtin",
                        "unit": "Percent",
                        "sampleRate": "PT15S"
                      },
                      {
                        "annotation": [
                          {
                            "displayName": "CPU privileged time",
                            "locale": "en-us"
                          }
                        ],
                        "class": "processor",
                        "condition": "IsAggregate=TRUE",
                        "counter": "percentprivilegedtime",
                        "counterSpecifier": "/builtin/processor/percentprivilegedtime",
                        "type": "builtin",
                        "unit": "Percent",
                        "sampleRate": "PT15S"
                      },
                      {
                        "annotation": [
                          {
                            "displayName": "Memory available",
                            "locale": "en-us"
                          }
                        ],
                        "class": "memory",
                        "counter": "availablememory",
                        "counterSpecifier": "/builtin/memory/availablememory",
                        "type": "builtin",
                        "unit": "Bytes",
                        "sampleRate": "PT15S"
                      },
                      {
                        "annotation": [
                          {
                            "displayName": "Swap percent used",
                            "locale": "en-us"
                          }
                        ],
                        "class": "memory",
                        "counter": "percentusedswap",
                        "counterSpecifier": "/builtin/memory/percentusedswap",
                        "type": "builtin",
                        "unit": "Percent",
                        "sampleRate": "PT15S"
                      },
                      {
                        "annotation": [
                          {
                            "displayName": "Memory used",
                            "locale": "en-us"
                          }
                        ],
                        "class": "memory",
                        "counter": "usedmemory",
                        "counterSpecifier": "/builtin/memory/usedmemory",
                        "type": "builtin",
                        "unit": "Bytes",
                        "sampleRate": "PT15S"
                      },
                      {
                        "annotation": [
                          {
                            "displayName": "Page reads",
                            "locale": "en-us"
                          }
                        ],
                        "class": "memory",
                        "counter": "pagesreadpersec",
                        "counterSpecifier": "/builtin/memory/pagesreadpersec",
                        "type": "builtin",
                        "unit": "CountPerSecond",
                        "sampleRate": "PT15S"
                      },
                      {
                        "annotation": [
                          {
                            "displayName": "Swap available",
                            "locale": "en-us"
                          }
                        ],
                        "class": "memory",
                        "counter": "availableswap",
                        "counterSpecifier": "/builtin/memory/availableswap",
                        "type": "builtin",
                        "unit": "Bytes",
                        "sampleRate": "PT15S"
                      },
                      {
                        "annotation": [
                          {
                            "displayName": "Swap percent available",
                            "locale": "en-us"
                          }
                        ],
                        "class": "memory",
                        "counter": "percentavailableswap",
                        "counterSpecifier": "/builtin/memory/percentavailableswap",
                        "type": "builtin",
                        "unit": "Percent",
                        "sampleRate": "PT15S"
                      },
                      {
                        "annotation": [
                          {
                            "displayName": "Mem. percent available",
                            "locale": "en-us"
                          }
                        ],
                        "class": "memory",
                        "counter": "percentavailablememory",
                        "counterSpecifier": "/builtin/memory/percentavailablememory",
                        "type": "builtin",
                        "unit": "Percent",
                        "sampleRate": "PT15S"
                      },
                      {
                        "annotation": [
                          {
                            "displayName": "Pages",
                            "locale": "en-us"
                          }
                        ],
                        "class": "memory",
                        "counter": "pagespersec",
                        "counterSpecifier": "/builtin/memory/pagespersec",
                        "type": "builtin",
                        "unit": "CountPerSecond",
                        "sampleRate": "PT15S"
                      },
                      {
                        "annotation": [
                          {
                            "displayName": "Swap used",
                            "locale": "en-us"
                          }
                        ],
                        "class": "memory",
                        "counter": "usedswap",
                        "counterSpecifier": "/builtin/memory/usedswap",
                        "type": "builtin",
                        "unit": "Bytes",
                        "sampleRate": "PT15S"
                      },
                      {
                        "annotation": [
                          {
                            "displayName": "Memory percentage",
                            "locale": "en-us"
                          }
                        ],
                        "class": "memory",
                        "counter": "percentusedmemory",
                        "counterSpecifier": "/builtin/memory/percentusedmemory",
                        "type": "builtin",
                        "unit": "Percent",
                        "sampleRate": "PT15S"
                      },
                      {
                        "annotation": [
                          {
                            "displayName": "Page writes",
                            "locale": "en-us"
                          }
                        ],
                        "class": "memory",
                        "counter": "pageswrittenpersec",
                        "counterSpecifier": "/builtin/memory/pageswrittenpersec",
                        "type": "builtin",
                        "unit": "CountPerSecond",
                        "sampleRate": "PT15S"
                      },
                      {
                        "annotation": [
                          {
                            "displayName": "Network in guest OS",
                            "locale": "en-us"
                          }
                        ],
                        "class": "network",
                        "counter": "bytesreceived",
                        "counterSpecifier": "/builtin/network/bytesreceived",
                        "type": "builtin",
                        "unit": "Bytes",
                        "sampleRate": "PT15S"
                      },
                      {
                        "annotation": [
                          {
                            "displayName": "Network total bytes",
                            "locale": "en-us"
                          }
                        ],
                        "class": "network",
                        "counter": "bytestotal",
                        "counterSpecifier": "/builtin/network/bytestotal",
                        "type": "builtin",
                        "unit": "Bytes",
                        "sampleRate": "PT15S"
                      },
                      {
                        "annotation": [
                          {
                            "displayName": "Network out guest OS",
                            "locale": "en-us"
                          }
                        ],
                        "class": "network",
                        "counter": "bytestransmitted",
                        "counterSpecifier": "/builtin/network/bytestransmitted",
                        "type": "builtin",
                        "unit": "Bytes",
                        "sampleRate": "PT15S"
                      },
                      {
                        "annotation": [
                          {
                            "displayName": "Network collisions",
                            "locale": "en-us"
                          }
                        ],
                        "class": "network",
                        "counter": "totalcollisions",
                        "counterSpecifier": "/builtin/network/totalcollisions",
                        "type": "builtin",
                        "unit": "Count",
                        "sampleRate": "PT15S"
                      },
                      {
                        "annotation": [
                          {
                            "displayName": "Packets received errors",
                            "locale": "en-us"
                          }
                        ],
                        "class": "network",
                        "counter": "totalrxerrors",
                        "counterSpecifier": "/builtin/network/totalrxerrors",
                        "type": "builtin",
                        "unit": "Count",
                        "sampleRate": "PT15S"
                      },
                      {
                        "annotation": [
                          {
                            "displayName": "Packets sent",
                            "locale": "en-us"
                          }
                        ],
                        "class": "network",
                        "counter": "packetstransmitted",
                        "counterSpecifier": "/builtin/network/packetstransmitted",
                        "type": "builtin",
                        "unit": "Count",
                        "sampleRate": "PT15S"
                      },
                      {
                        "annotation": [
                          {
                            "displayName": "Packets received",
                            "locale": "en-us"
                          }
                        ],
                        "class": "network",
                        "counter": "packetsreceived",
                        "counterSpecifier": "/builtin/network/packetsreceived",
                        "type": "builtin",
                        "unit": "Count",
                        "sampleRate": "PT15S"
                      },
                      {
                        "annotation": [
                          {
                            "displayName": "Packets sent errors",
                            "locale": "en-us"
                          }
                        ],
                        "class": "network",
                        "counter": "totaltxerrors",
                        "counterSpecifier": "/builtin/network/totaltxerrors",
                        "type": "builtin",
                        "unit": "Count",
                        "sampleRate": "PT15S"
                      },
                      {
                        "annotation": [
                          {
                            "displayName": "Filesystem transfers/sec",
                            "locale": "en-us"
                          }
                        ],
                        "class": "filesystem",
                        "condition": "IsAggregate=TRUE",
                        "counter": "transferspersecond",
                        "counterSpecifier": "/builtin/filesystem/transferspersecond",
                        "type": "builtin",
                        "unit": "CountPerSecond",
                        "sampleRate": "PT15S"
                      },
                      {
                        "annotation": [
                          {
                            "displayName": "Filesystem % free space",
                            "locale": "en-us"
                          }
                        ],
                        "class": "filesystem",
                        "condition": "IsAggregate=TRUE",
                        "counter": "percentfreespace",
                        "counterSpecifier": "/builtin/filesystem/percentfreespace",
                        "type": "builtin",
                        "unit": "Percent",
                        "sampleRate": "PT15S"
                      },
                      {
                        "annotation": [
                          {
                            "displayName": "Filesystem % used space",
                            "locale": "en-us"
                          }
                        ],
                        "class": "filesystem",
                        "condition": "IsAggregate=TRUE",
                        "counter": "percentusedspace",
                        "counterSpecifier": "/builtin/filesystem/percentusedspace",
                        "type": "builtin",
                        "unit": "Percent",
                        "sampleRate": "PT15S"
                      },
                      {
                        "annotation": [
                          {
                            "displayName": "Filesystem used space",
                            "locale": "en-us"
                          }
                        ],
                        "class": "filesystem",
                        "condition": "IsAggregate=TRUE",
                        "counter": "usedspace",
                        "counterSpecifier": "/builtin/filesystem/usedspace",
                        "type": "builtin",
                        "unit": "Bytes",
                        "sampleRate": "PT15S"
                      },
                      {
                        "annotation": [
                          {
                            "displayName": "Filesystem read bytes/sec",
                            "locale": "en-us"
                          }
                        ],
                        "class": "filesystem",
                        "condition": "IsAggregate=TRUE",
                        "counter": "bytesreadpersecond",
                        "counterSpecifier": "/builtin/filesystem/bytesreadpersecond",
                        "type": "builtin",
                        "unit": "CountPerSecond",
                        "sampleRate": "PT15S"
                      },
                      {
                        "annotation": [
                          {
                            "displayName": "Filesystem free space",
                            "locale": "en-us"
                          }
                        ],
                        "class": "filesystem",
                        "condition": "IsAggregate=TRUE",
                        "counter": "freespace",
                        "counterSpecifier": "/builtin/filesystem/freespace",
                        "type": "builtin",
                        "unit": "Bytes",
                        "sampleRate": "PT15S"
                      },
                      {
                        "annotation": [
                          {
                            "displayName": "Filesystem % free inodes",
                            "locale": "en-us"
                          }
                        ],
                        "class": "filesystem",
                        "condition": "IsAggregate=TRUE",
                        "counter": "percentfreeinodes",
                        "counterSpecifier": "/builtin/filesystem/percentfreeinodes",
                        "type": "builtin",
                        "unit": "Percent",
                        "sampleRate": "PT15S"
                      },
                      {
                        "annotation": [
                          {
                            "displayName": "Filesystem bytes/sec",
                            "locale": "en-us"
                          }
                        ],
                        "class": "filesystem",
                        "condition": "IsAggregate=TRUE",
                        "counter": "bytespersecond",
                        "counterSpecifier": "/builtin/filesystem/bytespersecond",
                        "type": "builtin",
                        "unit": "BytesPerSecond",
                        "sampleRate": "PT15S"
                      },
                      {
                        "annotation": [
                          {
                            "displayName": "Filesystem reads/sec",
                            "locale": "en-us"
                          }
                        ],
                        "class": "filesystem",
                        "condition": "IsAggregate=TRUE",
                        "counter": "readspersecond",
                        "counterSpecifier": "/builtin/filesystem/readspersecond",
                        "type": "builtin",
                        "unit": "CountPerSecond",
                        "sampleRate": "PT15S"
                      },
                      {
                        "annotation": [
                          {
                            "displayName": "Filesystem write bytes/sec",
                            "locale": "en-us"
                          }
                        ],
                        "class": "filesystem",
                        "condition": "IsAggregate=TRUE",
                        "counter": "byteswrittenpersecond",
                        "counterSpecifier": "/builtin/filesystem/byteswrittenpersecond",
                        "type": "builtin",
                        "unit": "CountPerSecond",
                        "sampleRate": "PT15S"
                      },
                      {
                        "annotation": [
                          {
                            "displayName": "Filesystem writes/sec",
                            "locale": "en-us"
                          }
                        ],
                        "class": "filesystem",
                        "condition": "IsAggregate=TRUE",
                        "counter": "writespersecond",
                        "counterSpecifier": "/builtin/filesystem/writespersecond",
                        "type": "builtin",
                        "unit": "CountPerSecond",
                        "sampleRate": "PT15S"
                      },
                      {
                        "annotation": [
                          {
                            "displayName": "Filesystem % used inodes",
                            "locale": "en-us"
                          }
                        ],
                        "class": "filesystem",
                        "condition": "IsAggregate=TRUE",
                        "counter": "percentusedinodes",
                        "counterSpecifier": "/builtin/filesystem/percentusedinodes",
                        "type": "builtin",
                        "unit": "Percent",
                        "sampleRate": "PT15S"
                      },
                      {
                        "annotation": [
                          {
                            "displayName": "Disk read guest OS",
                            "locale": "en-us"
                          }
                        ],
                        "class": "disk",
                        "condition": "IsAggregate=TRUE",
                        "counter": "readbytespersecond",
                        "counterSpecifier": "/builtin/disk/readbytespersecond",
                        "type": "builtin",
                        "unit": "BytesPerSecond",
                        "sampleRate": "PT15S"
                      },
                      {
                        "annotation": [
                          {
                            "displayName": "Disk writes",
                            "locale": "en-us"
                          }
                        ],
                        "class": "disk",
                        "condition": "IsAggregate=TRUE",
                        "counter": "writespersecond",
                        "counterSpecifier": "/builtin/disk/writespersecond",
                        "type": "builtin",
                        "unit": "CountPerSecond",
                        "sampleRate": "PT15S"
                      },
                      {
                        "annotation": [
                          {
                            "displayName": "Disk transfer time",
                            "locale": "en-us"
                          }
                        ],
                        "class": "disk",
                        "condition": "IsAggregate=TRUE",
                        "counter": "averagetransfertime",
                        "counterSpecifier": "/builtin/disk/averagetransfertime",
                        "type": "builtin",
                        "unit": "Seconds",
                        "sampleRate": "PT15S"
                      },
                      {
                        "annotation": [
                          {
                            "displayName": "Disk transfers",
                            "locale": "en-us"
                          }
                        ],
                        "class": "disk",
                        "condition": "IsAggregate=TRUE",
                        "counter": "transferspersecond",
                        "counterSpecifier": "/builtin/disk/transferspersecond",
                        "type": "builtin",
                        "unit": "CountPerSecond",
                        "sampleRate": "PT15S"
                      },
                      {
                        "annotation": [
                          {
                            "displayName": "Disk write guest OS",
                            "locale": "en-us"
                          }
                        ],
                        "class": "disk",
                        "condition": "IsAggregate=TRUE",
                        "counter": "writebytespersecond",
                        "counterSpecifier": "/builtin/disk/writebytespersecond",
                        "type": "builtin",
                        "unit": "BytesPerSecond",
                        "sampleRate": "PT15S"
                      },
                      {
                        "annotation": [
                          {
                            "displayName": "Disk read time",
                            "locale": "en-us"
                          }
                        ],
                        "class": "disk",
                        "condition": "IsAggregate=TRUE",
                        "counter": "averagereadtime",
                        "counterSpecifier": "/builtin/disk/averagereadtime",
                        "type": "builtin",
                        "unit": "Seconds",
                        "sampleRate": "PT15S"
                      },
                      {
                        "annotation": [
                          {
                            "displayName": "Disk write time",
                            "locale": "en-us"
                          }
                        ],
                        "class": "disk",
                        "condition": "IsAggregate=TRUE",
                        "counter": "averagewritetime",
                        "counterSpecifier": "/builtin/disk/averagewritetime",
                        "type": "builtin",
                        "unit": "Seconds",
                        "sampleRate": "PT15S"
                      },
                      {
                        "annotation": [
                          {
                            "displayName": "Disk total bytes",
                            "locale": "en-us"
                          }
                        ],
                        "class": "disk",
                        "condition": "IsAggregate=TRUE",
                        "counter": "bytespersecond",
                        "counterSpecifier": "/builtin/disk/bytespersecond",
                        "type": "builtin",
                        "unit": "BytesPerSecond",
                        "sampleRate": "PT15S"
                      },
                      {
                        "annotation": [
                          {
                            "displayName": "Disk reads",
                            "locale": "en-us"
                          }
                        ],
                        "class": "disk",
                        "condition": "IsAggregate=TRUE",
                        "counter": "readspersecond",
                        "counterSpecifier": "/builtin/disk/readspersecond",
                        "type": "builtin",
                        "unit": "CountPerSecond",
                        "sampleRate": "PT15S"
                      },
                      {
                        "annotation": [
                          {
                            "displayName": "Disk queue length",
                            "locale": "en-us"
                          }
                        ],
                        "class": "disk",
                        "condition": "IsAggregate=TRUE",
                        "counter": "averagediskqueuelength",
                        "counterSpecifier": "/builtin/disk/averagediskqueuelength",
                        "type": "builtin",
                        "unit": "Count",
                        "sampleRate": "PT15S"
                      }
                    ]
                  }
                },
                "sampleRateInSeconds": 15
              }
            }
          }
        },
        {
          "type": "Microsoft.Compute/virtualMachines/extensions",
          "name": "[concat(variables('jumpBoxName'),'-linux/Microsoft.EnterpriseCloud.Monitoring')]",
          "apiVersion": "2017-03-30",
          "location": "[resourceGroup().location]",
          "dependsOn": [
            "[concat('Microsoft.Compute/virtualMachines/',variables('jumpBoxName'),'-linux')]",
            "[concat('Microsoft.OperationalInsights/workspaces/', variables('omsWorkspaceName'))]"
          ],
          "properties": {
            "publisher": "Microsoft.EnterpriseCloud.Monitoring",
            "type": "OmsAgentForLinux",
            "typeHandlerVersion": "1.4",
            "autoUpgradeMinorVersion": true,
            "settings": {
              "workspaceId": "[reference(resourceId('Microsoft.OperationalInsights/workspaces/',variables('omsWorkspaceName')),'2015-03-20').customerId]"
            },
            "protectedSettings": {
              "workspaceKey": "[listKeys(resourceId('Microsoft.OperationalInsights/workspaces/',variables('omsWorkspaceName')),'2015-03-20').primarySharedKey]"
            }
          }
        }
      ],
      "dependsOn": [
        "[concat('Microsoft.Network/networkInterfaces/',variables('jumpBoxName'))]",
        "[concat('Microsoft.OperationalInsights/workspaces/',variables('omsWorkspaceName'))]",
        "[concat('Microsoft.Storage/storageAccounts/',variables('diagsName'))]"
      ]
    },
    {
      "comments": "RDP jumpbox",
      "condition": "[equals(variables('bastionOSType'),'Windows')]",
      "type": "Microsoft.Compute/virtualMachines",
      "name": "[concat(variables('jumpBoxName'),'-windows')]",
      "apiVersion": "2017-03-30",
      "location": "[resourceGroup().location]",
      "tags": {
        "tenant": "[variables('tenantName')]",
        "layer": "foundation",
        "purpose": "jumpbox",
        "services": "[parameters('servicesTag')]",
        "os": "windows"
      },
      "properties": {
        "osProfile": {
          "computerName": "jumpbox",
          "adminUsername": "[parameters('adminUsername')]",
          "adminPassword": "[parameters('adminPassword')]",
          "windowsConfiguration": {
              "provisionVMAgent": true,
              "enableAutomaticUpdates": true
          },
          "secrets": []
        },
        "hardwareProfile": {
          "vmSize": "[parameters('jumpBoxSize')]"
        },
        "storageProfile": {
          "imageReference": {
            "publisher": "MicrosoftWindowsServer",
            "offer": "WindowsServer",
            "sku": "2016-Datacenter",
            "version": "latest"
          },
          "osDisk": {
            "osType": "Windows",
            "name": "[variables('jumpBoxName')]",
            "caching": "ReadWrite",
            "createOption": "FromImage",
            "diskSizeGB": 128
          },
          "dataDisks": []
        },
        "networkProfile": {
          "networkInterfaces": [
            {
              "id": "[resourceId('Microsoft.Network/networkInterfaces',variables('jumpBoxName'))]"
            }
          ]
        },
        "diagnosticsProfile": {
          "bootDiagnostics": {
            "enabled": true,
            "storageUri": "[concat('https', '://', variables('diagsName'), '.blob.core.windows.net')]"
          }
        }
      },
      "resources": [
        {
          "type": "Microsoft.Compute/virtualMachines/extensions",
          "name": "[concat(variables('jumpBoxName'), '-windows/Microsoft.Azure.Diagnostics')]",
          "apiVersion": "2017-03-30",
          "location": "[resourceGroup().location]",
          "dependsOn": [
            "[concat('Microsoft.Compute/virtualMachines/',variables('jumpBoxName'),'-windows')]",
            "[concat('Microsoft.Storage/storageAccounts/',variables('diagsName'))]"
          ],
          "properties": {
            "publisher": "Microsoft.Azure.Diagnostics",
            "type": "IaaSDiagnostics",
            "typeHandlerVersion": "1.11",
            "autoUpgradeMinorVersion": true,
            "protectedSettings": {
              "storageAccount": "[variables('diagsName')]",
              "storageAccountKey": "[listKeys(resourceId('Microsoft.Storage/storageAccounts/',variables('diagsName')), '2015-06-15').key1]",
              "storageAccountEndPoint": "https://core.windows.net"
            },
            "settings": {
              "storageAccount": "[variables('diagsName')]",
              "WadCfg": {
                "DiagnosticMonitorConfiguration": {
                  "overallQuotaInMB": 5120,
                  "Metrics": {
                    "resourceId": "[resourceId('Microsoft.Compute/virtualMachines',concat(variables('jumpBoxName'),'-windows'))]",
                    "MetricAggregation": [
                      {
                        "scheduledTransferPeriod": "PT1H"
                      },
                      {
                        "scheduledTransferPeriod": "PT1M"
                      }
                    ]
                  },
                  "DiagnosticInfrastructureLogs": {
                    "scheduledTransferLogLevelFilter": "Error"
                  },
                  "PerformanceCounters": {
                    "scheduledTransferPeriod": "PT1M",
                    "PerformanceCounterConfiguration": [
                      {
                        "counterSpecifier": "\\Processor Information(_Total)\\% Processor Time",
                        "sampleRate": "PT1M"
                      },
                      {
                        "counterSpecifier": "\\Processor Information(_Total)\\% Privileged Time",
                        "sampleRate": "PT1M"
                      },
                      {
                        "counterSpecifier": "\\Processor Information(_Total)\\% User Time",
                        "sampleRate": "PT1M"
                      },
                      {
                        "counterSpecifier": "\\Processor Information(_Total)\\Processor Frequency",
                        "sampleRate": "PT1M"
                      },
                      {
                        "counterSpecifier": "\\System\\Processes",
                        "sampleRate": "PT1M"
                      },
                      {
                        "counterSpecifier": "\\Process(_Total)\\Thread Count",
                        "sampleRate": "PT1M"
                      },
                      {
                        "counterSpecifier": "\\Process(_Total)\\Handle Count",
                        "sampleRate": "PT1M"
                      },
                      {
                        "counterSpecifier": "\\System\\System Up Time",
                        "sampleRate": "PT1M"
                      },
                      {
                        "counterSpecifier": "\\System\\Context Switches/sec",
                        "sampleRate": "PT1M"
                      },
                      {
                        "counterSpecifier": "\\System\\Processor Queue Length",
                        "sampleRate": "PT1M"
                      },
                      {
                        "counterSpecifier": "\\Memory\\% Committed Bytes In Use",
                        "sampleRate": "PT1M"
                      },
                      {
                        "counterSpecifier": "\\Memory\\Available Bytes",
                        "sampleRate": "PT1M"
                      },
                      {
                        "counterSpecifier": "\\Memory\\Committed Bytes",
                        "sampleRate": "PT1M"
                      },
                      {
                        "counterSpecifier": "\\Memory\\Cache Bytes",
                        "sampleRate": "PT1M"
                      },
                      {
                        "counterSpecifier": "\\Memory\\Pool Paged Bytes",
                        "sampleRate": "PT1M"
                      },
                      {
                        "counterSpecifier": "\\Memory\\Pool Nonpaged Bytes",
                        "sampleRate": "PT1M"
                      },
                      {
                        "counterSpecifier": "\\Memory\\Pages/sec",
                        "sampleRate": "PT1M"
                      },
                      {
                        "counterSpecifier": "\\Memory\\Page Faults/sec",
                        "sampleRate": "PT1M"
                      },
                      {
                        "counterSpecifier": "\\Process(_Total)\\Working Set",
                        "sampleRate": "PT1M"
                      },
                      {
                        "counterSpecifier": "\\Process(_Total)\\Working Set - Private",
                        "sampleRate": "PT1M"
                      },
                      {
                        "counterSpecifier": "\\LogicalDisk(_Total)\\% Disk Time",
                        "sampleRate": "PT1M"
                      },
                      {
                        "counterSpecifier": "\\LogicalDisk(_Total)\\% Disk Read Time",
                        "sampleRate": "PT1M"
                      },
                      {
                        "counterSpecifier": "\\LogicalDisk(_Total)\\% Disk Write Time",
                        "sampleRate": "PT1M"
                      },
                      {
                        "counterSpecifier": "\\LogicalDisk(_Total)\\% Idle Time",
                        "sampleRate": "PT1M"
                      },
                      {
                        "counterSpecifier": "\\LogicalDisk(_Total)\\Disk Bytes/sec",
                        "sampleRate": "PT1M"
                      },
                      {
                        "counterSpecifier": "\\LogicalDisk(_Total)\\Disk Read Bytes/sec",
                        "sampleRate": "PT1M"
                      },
                      {
                        "counterSpecifier": "\\LogicalDisk(_Total)\\Disk Write Bytes/sec",
                        "sampleRate": "PT1M"
                      },
                      {
                        "counterSpecifier": "\\LogicalDisk(_Total)\\Disk Transfers/sec",
                        "sampleRate": "PT1M"
                      },
                      {
                        "counterSpecifier": "\\LogicalDisk(_Total)\\Disk Reads/sec",
                        "sampleRate": "PT1M"
                      },
                      {
                        "counterSpecifier": "\\LogicalDisk(_Total)\\Disk Writes/sec",
                        "sampleRate": "PT1M"
                      },
                      {
                        "counterSpecifier": "\\LogicalDisk(_Total)\\Avg. Disk sec/Transfer",
                        "sampleRate": "PT1M"
                      },
                      {
                        "counterSpecifier": "\\LogicalDisk(_Total)\\Avg. Disk sec/Read",
                        "sampleRate": "PT1M"
                      },
                      {
                        "counterSpecifier": "\\LogicalDisk(_Total)\\Avg. Disk sec/Write",
                        "sampleRate": "PT1M"
                      },
                      {
                        "counterSpecifier": "\\LogicalDisk(_Total)\\Avg. Disk Queue Length",
                        "sampleRate": "PT1M"
                      },
                      {
                        "counterSpecifier": "\\LogicalDisk(_Total)\\Avg. Disk Read Queue Length",
                        "sampleRate": "PT1M"
                      },
                      {
                        "counterSpecifier": "\\LogicalDisk(_Total)\\Avg. Disk Write Queue Length",
                        "sampleRate": "PT1M"
                      },
                      {
                        "counterSpecifier": "\\LogicalDisk(_Total)\\% Free Space",
                        "sampleRate": "PT1M"
                      },
                      {
                        "counterSpecifier": "\\LogicalDisk(_Total)\\Free Megabytes",
                        "sampleRate": "PT1M"
                      },
                      {
                        "counterSpecifier": "\\Network Interface(*)\\Bytes Total/sec",
                        "sampleRate": "PT1M"
                      },
                      {
                        "counterSpecifier": "\\Network Interface(*)\\Bytes Sent/sec",
                        "sampleRate": "PT1M"
                      },
                      {
                        "counterSpecifier": "\\Network Interface(*)\\Bytes Received/sec",
                        "sampleRate": "PT1M"
                      },
                      {
                        "counterSpecifier": "\\Network Interface(*)\\Packets/sec",
                        "sampleRate": "PT1M"
                      },
                      {
                        "counterSpecifier": "\\Network Interface(*)\\Packets Sent/sec",
                        "sampleRate": "PT1M"
                      },
                      {
                        "counterSpecifier": "\\Network Interface(*)\\Packets Received/sec",
                        "sampleRate": "PT1M"
                      },
                      {
                        "counterSpecifier": "\\Network Interface(*)\\Packets Outbound Errors",
                        "sampleRate": "PT1M"
                      },
                      {
                        "counterSpecifier": "\\Network Interface(*)\\Packets Received Errors",
                        "sampleRate": "PT1M"
                      }
                    ]
                  },
                  "WindowsEventLog": {
                    "scheduledTransferPeriod": "PT1M",
                    "DataSource": [
                      {
                        "name": "Application!*[System[(Level = 1 or Level = 2 or Level = 3)]]"
                      },
                      {
                        "name": "Security!*[System[band(Keywords,4503599627370496)]]"
                      },
                      {
                        "name": "System!*[System[(Level = 1 or Level = 2 or Level = 3)]]"
                      }
                    ]
                  }
                }
              }
            }
          }
        },
        {
          "type": "Microsoft.Compute/virtualMachines/extensions",
          "name": "[concat(variables('jumpBoxName'), '-windows/Microsoft.EnterpriseCloud.Monitoring')]",
          "apiVersion": "2017-03-30",
          "location": "[resourceGroup().location]",
          "dependsOn": [
            "[concat('Microsoft.Compute/virtualMachines/', variables('jumpBoxName'),'-windows')]",
            "[concat('Microsoft.OperationalInsights/workspaces/', variables('omsWorkspaceName'))]"
          ],
          "properties": {
            "publisher": "Microsoft.EnterpriseCloud.Monitoring",
            "type": "MicrosoftMonitoringAgent",
            "typeHandlerVersion": "1.0",
            "autoUpgradeMinorVersion": true,
            "settings": {
              "workspaceId": "[reference(resourceId('Microsoft.OperationalInsights/workspaces/', variables('omsWorkspaceName')), '2015-03-20').customerId]"
            },
            "protectedSettings": {
              "workspaceKey": "[listKeys(resourceId('Microsoft.OperationalInsights/workspaces/', variables('omsWorkspaceName')), '2015-03-20').primarySharedKey]"
            }
          }
        }
      ],
      "dependsOn": [
        "[concat('Microsoft.Network/networkInterfaces/',variables('jumpBoxName'))]",
        "[concat('Microsoft.OperationalInsights/workspaces/', variables('omsWorkspaceName'))]",
        "[concat('Microsoft.Storage/storageAccounts/',variables('diagsName'))]"
      ]
    },
    {
      "type": "Microsoft.Network/networkInterfaces",
      "name": "[variables('jumpBoxName')]",
      "apiVersion": "2017-06-01",
      "location": "[resourceGroup().location]",
      "tags": {
        "tenant": "[variables('tenantName')]",
        "layer": "foundation"
      },
      "properties": {
        "primary": true,
        "ipConfigurations": [
          {
            "name": "ipconfig1",
            "properties": {
              "subnet": {
                "id": "[concat(resourceId('Microsoft.Network/virtualNetworks', variables('vnetName')), '/subnets/', parameters('serverSubnet'))]"
              },
              "publicIpAddress": {
                "id": "[resourceId('Microsoft.Network/publicIpAddresses', variables('jumpBoxName'))]"
              }
            }
          }
        ],
        "networkSecurityGroup": {
          "id": "[resourceId('Microsoft.Network/networkSecurityGroups', variables('jumpBoxName'))]"
        }
      },
      "dependsOn": [
        "[concat('Microsoft.Network/virtualNetworks/', variables('vnetName'))]",
        "[concat('Microsoft.Network/publicIpAddresses/', variables('jumpBoxName'))]",
        "[concat('Microsoft.Network/networkSecurityGroups/', variables('jumpBoxName'))]"
      ]
    },
    {
      "comments": "Jumpbox public IP",
      "type": "Microsoft.Network/publicIPAddresses",
      "name": "[variables('jumpBoxName')]",
      "location": "[resourceGroup().location]",
      "tags": {
        "tenant": "[variables('tenantName')]",
        "layer": "foundation"
      },
      "apiVersion": "2015-06-15",
      "properties": {
        "publicIPAllocationMethod": "Dynamic",
        "dnsSettings": {
          "domainNameLabel": "[concat(resourceGroup().name, '-jumpbox')]"
        }
      }
    },
    {
      "comments": "NSG for Linux jumpbox",
      "condition": "[equals(variables('bastionOSType'),'Linux')]",
      "type": "Microsoft.Network/networkSecurityGroups",
      "name": "[variables('jumpBoxName')]",
      "apiVersion": "2015-06-15",
      "location": "[resourceGroup().location]",
      "tags": {
        "tenant": "[variables('tenantName')]",
        "layer": "foundation",
        "os": "linux"
      },
      "properties": {
        "securityRules": [
          {
            "name": "AllowSshInBound",
            "properties": {
              "priority": 1000,
              "sourceAddressPrefix": "*",
              "protocol": "Tcp",
              "destinationPortRange": "22",
              "access": "Allow",
              "direction": "Inbound",
              "sourcePortRange": "*",
              "destinationAddressPrefix": "*"
            }
          }
        ]
      }
    },
    {
      "comments": "NSG for Windows jumpbox",
      "condition": "[equals(variables('bastionOSType'),'Windows')]",
      "type": "Microsoft.Network/networkSecurityGroups",
      "name": "[concat(variables('jumpBoxName'),'-windows')]",
      "apiVersion": "2015-06-15",
      "location": "[resourceGroup().location]",
      "tags": {
        "tenant": "[variables('tenantName')]",
        "layer": "foundation",
        "os": "windows"
      },
      "properties": {
        "securityRules": [
          {
            "name": "AllowRdpInBound",
            "properties": {
              "priority": 1000,
              "sourceAddressPrefix": "*",
              "protocol": "Tcp",
              "destinationPortRange": "3389",
              "access": "Allow",
              "direction": "Inbound",
              "sourcePortRange": "*",
              "destinationAddressPrefix": "*"
            }
          }
        ]
      }
    },
    {
      "comments": "Shared network resource for other resource groups",
      "type": "Microsoft.Network/virtualNetworks",
      "name": "[variables('vnetName')]",
      "apiVersion": "2015-06-15",
      "location": "[resourceGroup().location]",
      "tags": {
        "tenant": "[variables('tenantName')]",
        "layer": "networking"
      },
      "properties": {
        "addressSpace": {
          "addressPrefixes": [
            "10.0.0.0/8"
          ]
        },
        "subnets": [
          {
            "name": "frontend",
            "properties": {
              "addressPrefix": "10.1.0.0/16"
            }
          },
          {
            "name": "middleware",
            "properties": {
              "addressPrefix": "10.2.0.0/16"
            }
          },
          {
            "name": "data",
            "properties": {
              "addressPrefix": "10.3.0.0/16"
            }
          },
          {
            "name": "devops",
            "properties": {
              "addressPrefix": "10.4.0.0/16"
            }
          }
        ]
      }
    },
    {
      "comments": "Log Analytics workspace",
      "apiVersion": "2017-03-15-preview",
      "location": "[resourceGroup().location]",
      "name": "[variables('omsWorkspaceName')]",
      "type": "Microsoft.OperationalInsights/workspaces",
      "properties": {
        "sku": {
          "name": "Free"
        }
      },
      "resources": [
        {
          "name": "AzureActivityLog",
          "type": "datasources",
          "apiVersion": "2015-11-01-preview",
          "dependsOn": [
            "[concat('Microsoft.OperationalInsights/workspaces/', variables('omsWorkspaceName'))]"
          ],
          "kind": "AzureActivityLog",
          "properties": {
            "linkedResourceId": "[concat(subscription().id, '/providers/Microsoft.Insights/eventTypes/management')]"
          }
        },
        {
          "apiVersion": "2015-11-01-preview",
          "type": "datasources",
          "name": "Linux",
          "dependsOn": [
            "[concat('Microsoft.OperationalInsights/workspaces/', variables('omsWorkspaceName'))]"
          ],
          "kind": "LinuxPerformanceObject",
          "properties": {
            "performanceCounters": [
              {
                "counterName": "% Used Inodes"
              },
              {
                "counterName": "Free Megabytes"
              },
              {
                "counterName": "% Used Space"
              },
              {
                "counterName": "Disk Transfers/sec"
              },
              {
                "counterName": "Disk Reads/sec"
              },
              {
                "counterName": "Disk Writes/sec"
              }
            ],
            "objectName": "Logical Disk",
            "instanceName": "*",
            "intervalSeconds": 10
          }
        },
        {
          "apiVersion": "2015-11-01-preview",
          "type": "datasources",
          "name": "LinuxPerfCollection",
          "dependsOn": [
            "[concat('Microsoft.OperationalInsights/workspaces/', variables('omsWorkspaceName'))]"
          ],
          "kind": "LinuxPerformanceCollection",
          "properties": {
            "state": "Enabled"
          }
        },
        {
          "apiVersion": "2015-11-01-preview",
          "type": "datasources",
          "name": "Syslog",
          "dependsOn": [
            "[concat('Microsoft.OperationalInsights/workspaces/', variables('omsWorkspaceName'))]"
          ],
          "kind": "LinuxSyslog",
          "properties": {
            "syslogName": "kern",
            "syslogSeverities": [
              {
                "severity": "emerg"
              },
              {
                "severity": "alert"
              },
              {
                "severity": "crit"
              },
              {
                "severity": "err"
              },
              {
                "severity": "warning"
              }
            ]
          }
        },
        {
          "apiVersion": "2015-11-01-preview",
          "type": "datasources",
          "name": "SyslogCollection",
          "dependsOn": [
            "[concat('Microsoft.OperationalInsights/workspaces/', variables('omsWorkspaceName'))]"
          ],
          "kind": "LinuxSyslogCollection",
          "properties": {
            "state": "Enabled"
          }
        },
        {
          "apiVersion": "2015-11-01-preview",
          "type": "datasources",
          "name": "sampleCustomLogCollection1",
          "dependsOn": [
            "[concat('Microsoft.OperationalInsights/workspaces/', variables('omsWorkspaceName'))]"
          ],
          "kind": "CustomLogCollection",
          "properties": {
            "state": "LinuxLogsEnabled"
          }
        },
        {
          "apiVersion": "2015-11-01-preview",
          "name": "Free Tier Data Consumption Tracker",
          "dependsOn": [
            "[concat('Microsoft.OperationalInsights/workspaces/', variables('omsWorkspaceName'))]"
          ],
          "type": "views",
          "properties": {
            "Id": "Free Tier Data Consumption Tracker",
            "Name": "Free Tier Data Consumption Tracker",
            "Dashboard": [
              {
                "Id": "InformationBlade",
                "Type": "Blade",
                "Version": 0,
                "Configuration": {
                  "General": {
                    "Title": "For More Information, Refer To The Following Blog Post",
                    "NewGroup": false,
                    "Color": "#0072c6"
                  },
                  "Header": {
                    "Image": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAYAAABXAvmHAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAztJREFUeNrUmktoE1EUhqexKj4zJWoaqIpVaVGxKr6ogsaNbhS0YKkKFeKmriwFEaXYnY+FYjeCbmtRRBeuXIlLMe1CXGlduBOt0rS1FaF2/A+ciWMy0yT3njvN/PBtMuHc8899zJ1zp8ZxHEtAKXAE7AdNYBOwGVKO+QQ+gDfgFfii23CNhoHV4CyzWzHGEBgEA2BUKQIZqJAG0A+mHTn9AvfB2krzqeTPi8AVMOWYE92UPrBY2kAzeOeEp/fcZsncYmWMsjaQBdut8LSN22zTnQMXwYwzf5rhHJSGUJdTPeoKyjNoGT0JnoIFCt1/GXwOuNYIbirE/APawbNyhlATmNS4W4fm6NW0Rlxa/baWmsQLwROwXGMC2orXSmkpeMw55lVooAe0aK4gcUMG3NWpJ8hAA+gVWAJtRXPlqpdzLTJwlbvJpAFbID7leK3QwCpwXughFDdsgNTJOecN0A9LhIKbHkIW59rpNdAhuA2wQ+gB0hnXQBLsiqCBnaCeDKTpxUYwcDwkA5TzYTLQKryTDGMOuDoQ44eDFcEhRNpCBtYJB42HaGC9O4klVRuwl1opPNdIa2KaG7dK7nSdgXZWxCwzskOYwPmtxISBuPEQxj9pnAx8NRC4LiQDo2RgJMI98DHGtUpppbgXvNSbMEAv9af5NTKKaicDtK/+ZmCNNi0qpyRpCH3nKnHUNOROYtIj4eDTXP9JMzfAlHAbg966UEKwXE71m70+NSH67bdgFTvhrQv9AA+E7sw98Nbnd/rtjlAbDznn/ypzKc2KnKuDc1TmWgXiT3KuRZU5Oq+6LrQ6BGlWIH6f5TlbK9zM9YNhzQaOKV4rR8M8RD23q7ibG0FOo4snwA6fuC18TVWU08Zyy+snwHNLrbxu8ZJ5F7zkIXUUdNP+XTEelddPgRfFAzZ4wmXAbBUcblAOF1QP+TJVcMSU0T2lPA7G5iH5HLctcsy6AWRDTD7LbYoedNeCS2DcYOK0SnVzW+In9S5JcEtzSfRL/DbHrigfnY896C2LPvQ4B/b4PBRLiZ7KdJg9wLvhMaUCqdDnNgkqtIJ9oBlspqITWMYvSj/5pWnE+ve5zev8hkxDfwUYAP0NkvYTPlJVAAAAAElFTkSuQmCC",
                    "Label": "Free Tier Data Consumption Tracker ",
                    "Link": {
                      "Label": "More info",
                      "Url": "https://blogs.msdn.microsoft.com/wei_out_there_with_system_center/2017/03/21/oms-free-tier-data-consumption-tracker-dashboard/"
                    }
                  },
                  "List": [
                    {
                      "Title": "Summary",
                      "Content": "In **Operations Management Suite (OMS)**, there is a Free Tier that allows up to **500 MB** of data upload per day for Log Analytics, with 7 days of data retention.\n\n\nThis solution features a custom OMS Dashboard – the **Free Tier Data Consumption Tracker** - that extends the Log Analytics Usage records used primarily to drive the Usage Dashboard. \nIt provides a summary view of the data quota consumption relative to the 500 MB daily data upload limit of the OMS Free Tier, calculated in percentage."
                    }
                  ]
                }
              },
              {
                "Id": "SingleQueryDonutBuilderBladeV1",
                "Type": "Blade",
                "Version": 0,
                "Configuration": {
                  "General": {
                    "title": "Free Tier Data Consumption by Solution & DataType",
                    "newGroup": false,
                    "icon": "",
                    "useIcon": false
                  },
                  "Header": {
                    "Title": "Free Tier Billable Data Consumption by Solution",
                    "Subtitle": "Last 24 Hours"
                  },
                  "Donut": {
                    "Query": "Type=Usage QuantityUnit=\"MBytes\" IsBillable=true TimeGenerated>NOW-24HOURS | Extend mul(Quantity,0.2) AS UsedFreeTierPercent | measure sum(UsedFreeTierPercent) AS TotalUsedFreeTierPercent by Solution",
                    "CenterLegend": {
                      "Text": "% Used",
                      "Operation": "Sum",
                      "ArcsToSelect": []
                    },
                    "Options": {
                      "colors": [
                        "#00188f",
                        "#0072c6",
                        "#00bcf2"
                      ],
                      "valueColorMapping": []
                    }
                  },
                  "List": {
                    "Query": "Type=Usage QuantityUnit=\"MBytes\" IsBillable=true TimeGenerated>NOW-24HOURS | Extend mul(Quantity,0.2) AS UsedFreeTierPercent | measure sum(UsedFreeTierPercent) AS TotalUsedFreeTierPercent by DataType, Solution",
                    "HideGraph": false,
                    "enableSparklines": false,
                    "operation": "Summary",
                    "ColumnsTitle": {
                      "Name": "Data Type",
                      "Value": "% Quota Used"
                    },
                    "Color": "#0072c6",
                    "thresholds": {
                      "isEnabled": true,
                      "values": [
                        {
                          "name": "Normal",
                          "threshold": "Default",
                          "color": "#009e49",
                          "isDefault": true
                        },
                        {
                          "name": "Warning",
                          "threshold": "75",
                          "color": "#fcd116",
                          "isDefault": false
                        },
                        {
                          "name": "Error",
                          "threshold": "95",
                          "color": "#ba141a",
                          "isDefault": false
                        }
                      ]
                    },
                    "NameDSVSeparator": "",
                    "NavigationQuery": "{selected item}"
                  }
                }
              },
              {
                "Id": "SingleQueryDonutBuilderBladeV1",
                "Type": "Blade",
                "Version": 0,
                "Configuration": {
                  "General": {
                    "title": "For Nodes/Endpoints/Computers Only",
                    "newGroup": false,
                    "icon": "",
                    "useIcon": false
                  },
                  "Header": {
                    "Title": "Free Tier Billable Data Consumption by DataType",
                    "Subtitle": "Last 24 Hours"
                  },
                  "Donut": {
                    "Query": "Type=Usage QuantityUnit=\"MBytes\" IsBillable=true Computer!=\"-\" TimeGenerated>NOW-24HOURS | Extend mul(Quantity,0.2) AS UsedFreeTierPercent | measure sum(UsedFreeTierPercent) AS TotalUsedFreeTierPercent by DataType",
                    "CenterLegend": {
                      "Text": "% Used",
                      "Operation": "Sum",
                      "ArcsToSelect": []
                    },
                    "Options": {
                      "colors": [
                        "#ff8c00",
                        "#ffb900",
                        "#fcd116"
                      ],
                      "valueColorMapping": []
                    }
                  },
                  "List": {
                    "Query": "Type=Usage QuantityUnit=\"MBytes\" IsBillable=true Computer!=\"-\" TimeGenerated>NOW-24HOURS | Extend mul(Quantity,0.2) AS UsedFreeTierPercent | measure sum(UsedFreeTierPercent) AS TotalUsedFreeTierPercent by Computer, DataType",
                    "HideGraph": false,
                    "enableSparklines": false,
                    "operation": "Summary",
                    "ColumnsTitle": {
                      "Name": "Node",
                      "Value": "% Quota Used"
                    },
                    "Color": "#fcd116",
                    "thresholds": {
                      "isEnabled": true,
                      "values": [
                        {
                          "name": "Normal",
                          "threshold": "Default",
                          "color": "#009e49",
                          "isDefault": true
                        },
                        {
                          "name": "Warning",
                          "threshold": "75",
                          "color": "#fcd116",
                          "isDefault": false
                        },
                        {
                          "name": "Error",
                          "threshold": "95",
                          "color": "#ba141a",
                          "isDefault": false
                        }
                      ]
                    },
                    "NameDSVSeparator": "",
                    "NavigationQuery": "{selected item}"
                  }
                }
              },
              {
                "Id": "SingleQueryDonutBuilderBladeV1",
                "Type": "Blade",
                "Version": 0,
                "Configuration": {
                  "General": {
                    "title": "For Non-Nodes ",
                    "newGroup": false,
                    "icon": "",
                    "useIcon": false
                  },
                  "Header": {
                    "Title": "Free Tier Billable Data Consumption by DataType",
                    "Subtitle": "Last 24 Hours"
                  },
                  "Donut": {
                    "Query": "Type=Usage QuantityUnit=\"MBytes\" IsBillable=true Computer=\"-\" TimeGenerated>NOW-24HOURS | Extend mul(Quantity,0.2) AS UsedFreeTierPercent | measure sum(UsedFreeTierPercent) AS TotalUsedFreeTierPercent by DataType",
                    "CenterLegend": {
                      "Text": "% Used",
                      "Operation": "Sum",
                      "ArcsToSelect": []
                    },
                    "Options": {
                      "colors": [
                        "#ec008c",
                        "#68217a",
                        "#6dc2e9"
                      ],
                      "valueColorMapping": []
                    }
                  },
                  "List": {
                    "Query": "Type=Usage QuantityUnit=\"MBytes\" IsBillable=true Computer=\"-\" TimeGenerated>NOW-24HOURS | Extend mul(Quantity,0.2) AS UsedFreeTierPercent | measure sum(UsedFreeTierPercent) AS TotalUsedFreeTierPercent by Solution",
                    "HideGraph": false,
                    "enableSparklines": false,
                    "operation": "Summary",
                    "ColumnsTitle": {
                      "Name": "OMS Solution",
                      "Value": "% Quota Used"
                    },
                    "Color": "#002050",
                    "thresholds": {
                      "isEnabled": true,
                      "values": [
                        {
                          "name": "Normal",
                          "threshold": "Default",
                          "color": "#009e49",
                          "isDefault": true
                        },
                        {
                          "name": "Warning",
                          "threshold": "75",
                          "color": "#fcd116",
                          "isDefault": false
                        },
                        {
                          "name": "Error",
                          "threshold": "95",
                          "color": "#ba141a",
                          "isDefault": false
                        }
                      ]
                    },
                    "NameDSVSeparator": "",
                    "NavigationQuery": "{selected item}"
                  }
                }
              },
              {
                "Id": "SingleQueryDonutBuilderBladeV1",
                "Type": "Blade",
                "Version": 0,
                "Configuration": {
                  "General": {
                    "title": "Billable vs Non-Billable Usage",
                    "newGroup": false,
                    "icon": "",
                    "useIcon": false
                  },
                  "Header": {
                    "Title": "Non-Billable Data Usage to Free Tier Comparison",
                    "Subtitle": "By DataType Over the Last 24 Hours"
                  },
                  "Donut": {
                    "Query": "Type=Usage QuantityUnit=\"MBytes\" IsBillable=false TimeGenerated>NOW-24HOURS | Extend mul(Quantity,0.2) AS UsedFreeTierPercent | measure sum(UsedFreeTierPercent) AS TotalUsedFreeTierPercent by DataType",
                    "CenterLegend": {
                      "Text": "% Total",
                      "Operation": "Sum",
                      "ArcsToSelect": []
                    },
                    "Options": {
                      "colors": [
                        "#e2e584",
                        "#bad80a",
                        "#009e49"
                      ],
                      "valueColorMapping": []
                    }
                  },
                  "List": {
                    "Query": "Type=Usage QuantityUnit=\"MBytes\" IsBillable=true TimeGenerated>NOW-24HOURS | Extend mul(Quantity,0.2) AS UsedFreeTierPercent | measure sum(UsedFreeTierPercent) AS TotalUsedFreeTierPercent by Type",
                    "HideGraph": false,
                    "enableSparklines": false,
                    "operation": "Summary",
                    "ColumnsTitle": {
                      "Name": "Billable Usage",
                      "Value": "% Quote Used"
                    },
                    "Color": "#ba141a",
                    "thresholds": {
                      "isEnabled": true,
                      "values": [
                        {
                          "name": "Normal",
                          "threshold": "Default",
                          "color": "#009e49",
                          "isDefault": true
                        },
                        {
                          "name": "Warning",
                          "threshold": "75",
                          "color": "#fcd116",
                          "isDefault": false
                        },
                        {
                          "name": "Error",
                          "threshold": "99",
                          "color": "#ba141a",
                          "isDefault": false
                        }
                      ]
                    },
                    "NameDSVSeparator": "",
                    "NavigationQuery": "{selected item}"
                  }
                }
              }
            ],
            "OverviewTile": {
              "Id": "SingleQueryDonutBuilderTileV1",
              "Type": "OverviewTile",
              "Version": 0,
              "Configuration": {
                "Donut": {
                  "Query": "Type=Usage QuantityUnit=\"MBytes\" IsBillable=true TimeGenerated>NOW-24HOURS | Extend mul(Quantity,0.2) AS UsedFreeTierPercent | measure sum(UsedFreeTierPercent) AS TotalUsedFreeTierPercent by Solution",
                  "CenterLegend": {
                    "Text": "% Quota Used",
                    "Operation": "Sum",
                    "ArcsToSelect": []
                  },
                  "Options": {
                    "colors": [
                      "#00188f",
                      "#0072c6",
                      "#00bcf2"
                    ],
                    "valueColorMapping": []
                  }
                },
                "Advanced": {
                  "DataFlowVerification": {
                    "Enabled": false,
                    "Query": "*",
                    "Message": ""
                  }
                }
              }
            }
          }
        }
      ]
    },
    {
      "apiVersion": "2015-11-01-preview",
      "type": "Microsoft.OperationsManagement/solutions",
      "name": "[concat(variables('omsConfig').solutions[copyIndex()].Name)]",
      "location": "[resourceGroup().location]",
      "dependsOn": [
        "[concat('Microsoft.OperationalInsights/workspaces/', variables('omsWorkspaceName'))]"
      ],
      "copy": {
        "name": "solutionCopy",
        "count": "[length(variables('omsConfig').solutions)]"
      },
      "properties": {
        "workspaceResourceId": "[resourceId('Microsoft.OperationalInsights/workspaces', variables('omsWorkspaceName'))]"
      },
      "plan": {
        "name": "[variables('omsConfig').solutions[copyIndex()].name]",
        "product": "[concat('OMSGallery/', variables('omsConfig').solutions[copyIndex()].marketplaceName)]",
        "promotionCode": "",
        "publisher": "Microsoft"
      }
    }
  ],
  "outputs": {
    "workspaceName": {
      "type": "string",
      "value": "[variables('omsWorkspaceName')]"
    },
    "provisioningState": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.OperationalInsights/workspaces', variables('omsWorkspaceName')), '2015-11-01-preview').provisioningState]"
    },
    "source": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.OperationalInsights/workspaces', variables('omsWorkspaceName')), '2015-11-01-preview').source]"
    },
    "customerId": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.OperationalInsights/workspaces', variables('omsWorkspaceName')), '2015-11-01-preview').customerId]"
    },
    "pricingTier": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.OperationalInsights/workspaces', variables('omsWorkspaceName')), '2015-11-01-preview').sku.name]"
    },
    "retentionInDays": {
      "type": "int",
      "value": "[reference(resourceId('Microsoft.OperationalInsights/workspaces', variables('omsWorkspaceName')), '2015-11-01-preview').retentionInDays]"
    },
    "portalUrl": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.OperationalInsights/workspaces', variables('omsWorkspaceName')), '2015-11-01-preview').portalUrl]"
    }
  }
}